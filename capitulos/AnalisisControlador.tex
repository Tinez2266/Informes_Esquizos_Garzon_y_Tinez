\section{Análisis del controlador}

En este apartado se analiza el comportamiento del controlador NMPC diseñado, evaluando su capacidad para seguir las referencias impuestas y respetar las restricciones del sistema bajo distintos escenarios. En primer lugar, se considera la simulación del sistema con los parámetros nominales definidos en la práctica, con el objetivo de verificar el correcto funcionamiento del modelo y del esquema de control implementado.

\subsection{Simulación con parámetros nominales}

\begin{figure}[H]
    \centering
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.55\linewidth,
        scale only axis=false,
        title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$x_m$ (m)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,4)(31,4)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,-4)(31,-4)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=xm
        ]{datos/PL6_1.dat};
        %\addlegendentry{$x_m$}
        \addplot[
            color=red,
            mark=none,
            dashed
        ]
        table[
        x=t,
        y=refxm
        ]{datos/PL6_1.dat};
        %\addlegendentry{$ref_{x_m}$}
    \end{axis}
    \end{tikzpicture}
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.55\linewidth,
        scale only axis=false,
        %title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$y_m$ (m)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,2)(31,2)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,0)(31,0)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=ym
        ]{datos/PL6_1.dat};
        %\addlegendentry{$x_m$}
        \addplot[
            color=red,
            mark=none,
            dashed
        ]
        table[
        x=t,
        y=refym
        ]{datos/PL6_1.dat};
        %\addlegendentry{$ref_{x_m}$}
    \end{axis}
    \end{tikzpicture}
    \caption{Comparación referencia vs Salidas del sistema según parámetros nominales}
    %\label{fig:Comparación de velocidad de salida $\omega_e$ con el modelo base}
\end{figure}%xm ym

Tras simular el sistema con los parámetros por defecto, se observa que las salidas correspondientes a las posiciones de la carga $x_m(t)$ e $y_m(t)$ siguen adecuadamente las trayectorias de referencia establecidas. En las figuras de seguimiento de posición se aprecia un buen acoplamiento entre referencia y salida, con errores de seguimiento reducidos y sin violaciones de las restricciones impuestas sobre los estados.

\begin{figure}[H]
    \centering
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.55\linewidth,
        scale only axis=false,
        title={Estados del sistema},
        xlabel={t(s)},
        ylabel={$f_x$ (N)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,50)(31,50)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,-50)(31,-50)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none,
            const plot
        ]
        table[
        x=t,
        y=fx
        ]{datos/PL6_1.dat};
        %\addlegendentry{$x_m$}
    \end{axis}
    \end{tikzpicture}
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.55\linewidth,
        scale only axis=false,
        %title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$f_l$ (N)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,50)(31,50)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,-50)(31,-50)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none,
            const plot
        ]
        table[
        x=t,
        y=fl
        ]{datos/PL6_1.dat};
        %\addlegendentry{$x_m$}
    \end{axis}
    \end{tikzpicture}
    \caption{Estados del sistema: Fuerzas de control según parámetros nominales}
    %\label{fig:Comparación de velocidad de salida $\omega_e$ con el modelo base}
\end{figure}%fl fx

\begin{figure}[H]
    \centering
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.55\linewidth,
        scale only axis=false,
        title={Estados del sistema},
        xlabel={t(s)},
        ylabel={$df_x$ (N/step)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,10)(31,10)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,-10)(31,-10)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none,
            const plot
        ]
        table[
        x=t,
        y=dfx
        ]{datos/PL6_1.dat};
        %\addlegendentry{$x_m$}
    \end{axis}
    \end{tikzpicture}
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.55\linewidth,
        scale only axis=false,
        %title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$df_l$ (N/step)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,10)(31,10)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,-10)(31,-10)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none,
            const plot
        ]
        table[
        x=t,
        y=dfl
        ]{datos/PL6_1.dat};
        %\addlegendentry{$x_m$}
    \end{axis}
    \end{tikzpicture}
    \caption{Estados del sistema: Variaciones de las fuerzas de control según parámetros nominales}
    %\label{fig:Comparación de velocidad de salida $\omega_e$ con el modelo base}
\end{figure}%dfx dfl

El comportamiento de las fuerzas de control $f_x(t)$ y $f_l(t)$ muestra una evolución suave y acotada, permaneciendo en todo momento dentro de los límites físicos definidos. De igual modo, las variaciones de las acciones de control $\Delta f_x(t)$ y $\Delta f_l(t)$ respetan las restricciones impuestas, lo que indica que el controlador gestiona correctamente la dinámica incremental de las fuerzas.

\begin{figure}[H]
    \centering
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.6\linewidth,
        scale only axis=false,
        title={Estados del sistema},
        xlabel={t(s)},
        ylabel={$x$ (m)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,5)(31,5)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,-5)(31,-5)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=x
        ]{datos/PL6_1.dat};
        %\addlegendentry{$x_m$}
    \end{axis}
    \end{tikzpicture}
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.6\linewidth,
        scale only axis=false,
        %title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$dl$ (m)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,2)(31,2)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,0)(31,0)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=l
        ]{datos/PL6_1.dat};
        %\addlegendentry{$x_m$}
    \end{axis}
    \end{tikzpicture}
    \begin{tikzpicture}
    \begin{axis}[
        width=0.92\linewidth,
        height=0.6\linewidth,
        scale only axis=false,
        %title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$\theta$ (rad)},
         y tick label style={
            /pgf/number format/fixed,
            /pgf/number format/precision=4
        },
        scaled y ticks=false,
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,0.07854)(31,0.07854)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,-0.07854)(31,-0.07854)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=theta
        ]{datos/PL6_1.dat};
        %\addlegendentry{$x_m$}
    \end{axis}
    \end{tikzpicture}
    \caption{Estados del sistema: Variables internas según parámetros nominales}
    %\label{fig:Comparación de velocidad de salida $\omega_e$ con el modelo base}
\end{figure}%x l theta

En cuanto a las variables internas del sistema, la posición del carro $x(t)$ y la longitud del cable $l(t)$ evolucionan de forma coherente con la trayectoria de la carga, sin presentar comportamientos no deseados ni saturaciones. El ángulo del péndulo $\theta(t)$ permanece próximo a cero durante todo el movimiento, cumpliendo el objetivo de minimizar las oscilaciones de la carga suspendida y confirmando la efectividad de la ponderación asignada a esta variable en la función de coste.

Finalmente, la representación gráfica del movimiento de la grúa confirma visualmente que la carga sigue la trayectoria deseada de forma estable y continua, sin oscilaciones excesivas ni comportamientos no físicos.

En conjunto, los resultados obtenidos indican que el modelo del sistema y el controlador NMPC están correctamente formulados, y que el esquema de control es capaz de seguir las referencias propuestas de manera satisfactoria, respetando simultáneamente las restricciones sobre estados y acciones de control para los parámetros introducidos.

\subsection{Reducción del límite del ángulo $\theta$}

Al reducir el límite admisible del ángulo a $\theta \in [-\pi/200,\ \pi/200]$, se observa un deterioro significativo en la capacidad del sistema para seguir la referencia impuesta en las coordenadas de la carga, siendo este efecto especialmente acusado en la posición horizontal $x_m(t)$.

\begin{figure}[H]
    \centering
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.6\linewidth,
        scale only axis=false,
        title={Estados del sistema},
        xlabel={t(s)},
        ylabel={$x$ (m)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,5)(31,5)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,-5)(31,-5)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=x
        ]{datos/PL6_2.dat};
        %\addlegendentry{$x_m$}
    \end{axis}
    \end{tikzpicture}
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.6\linewidth,
        scale only axis=false,
        %title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$dl$ (m)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,2)(31,2)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,0)(31,0)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=l
        ]{datos/PL6_2.dat};
        %\addlegendentry{$x_m$}
    \end{axis}
    \end{tikzpicture}
    \begin{tikzpicture}
    \begin{axis}[
        width=0.92\linewidth,
        height=0.6\linewidth,
        scale only axis=false,
        %title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$\theta$ (rad)},
         y tick label style={
            /pgf/number format/fixed,
            /pgf/number format/precision=4
        },
        scaled y ticks=false,
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,0.015708)(31,0.015708)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,-0.015708)(31,-0.015708)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=theta
        ]{datos/PL6_2.dat};
        %\addlegendentry{$x_m$}
    \end{axis}
    \end{tikzpicture}
    \caption{Estados del sistema: Variables internas con restricciones en $\theta$}
    %\label{fig:Comparación de velocidad de salida $\omega_e$ con el modelo base}
\end{figure}%x l theta

El análisis de las gráficas correspondientes a la evolución temporal de los estados pone de manifiesto que, durante toda la simulación, la mayoría de las variables del sistema permanecen claramente alejadas de sus respectivos límites impuestos por las restricciones. Sin embargo, el estado asociado al ángulo del péndulo $\theta(t)$ alcanza de forma reiterada los valores máximo y mínimo permitidos, saturando la restricción angular en múltiples intervalos de tiempo.

\begin{figure}[H]
    \centering
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.8\linewidth,
        scale only axis=false,
        title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$x_m$ (m)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,4)(31,4)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,-4)(31,-4)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=xm
        ]{datos/PL6_2.dat};
        %\addlegendentry{$x_m$}
        \addplot[
            color=red,
            mark=none,
            dashed
        ]
        table[
        x=t,
        y=refxm
        ]{datos/PL6_2.dat};
        %\addlegendentry{$ref_{x_m}$}
    \end{axis}
    \end{tikzpicture}
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.8\linewidth,
        scale only axis=false,
        %title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$y_m$ (m)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,2)(31,2)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,0)(31,0)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=ym
        ]{datos/PL6_2.dat};
        %\addlegendentry{$x_m$}
        \addplot[
            color=red,
            mark=none,
            dashed
        ]
        table[
        x=t,
        y=refym
        ]{datos/PL6_2.dat};
        %\addlegendentry{$ref_{x_m}$}
    \end{axis}
    \end{tikzpicture}
    \caption{Comparación referencia vs Salidas del sistema con restricciones en $\theta$}
    %\label{fig:Comparación de velocidad de salida $\omega_e$ con el modelo base}
\end{figure}%xm ym

Esta saturación del ángulo limita el grado de libertad del sistema para compensar la dinámica no lineal asociada al movimiento de la carga, impidiendo que el controlador utilice el balanceo del péndulo como mecanismo para mejorar el seguimiento de la trayectoria. Como consecuencia, el NMPC se ve forzado a priorizar estrictamente el cumplimiento de la restricción sobre $\theta(t)$, lo que deriva en un seguimiento deficiente de la referencia, particularmente en la coordenada $x_m(t)$, aunque también se aprecia una degradación en el comportamiento de $y_m(t)$.

Este resultado pone de manifiesto el compromiso existente entre la reducción de las oscilaciones del péndulo y la capacidad de seguimiento de la trayectoria, así como la fuerte interdependencia entre las restricciones angulares y el desempeño global del sistema en ambos ejes.

En resumen, la imposición de un límite más estricto sobre el ángulo del péndulo compromete la eficacia del controlador NMPC para seguir las referencias deseadas, evidenciando la necesidad de un equilibrio adecuado entre las restricciones y los objetivos de control para lograr un desempeño óptimo del sistema.

\subsection{Introducción de restricciones terminales}

Con el objetivo de mejorar la estabilidad del sistema, se introducen restricciones terminales imponiendo que los estados $\dot{\theta}$, $\dot{x}$ y $\dot{l}$ sean nulos al final del horizonte de predicción, mediante la condición
\[
\dot{\theta}(T)=\dot{x}(T)=\dot{l}(T)=0.
\]

\lstinputlisting[language=MATLAB, firstline=182, lastline=184]{codigo/ControladorNMPC_Grua.m}

A continuación, se simula nuevamente la respuesta del sistema empleando los parámetros originales y analizando el efecto de dichas restricciones sobre el comportamiento dinámico y el seguimiento de la referencia.

\begin{figure}[H]
    \centering
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.8\linewidth,
        scale only axis=false,
        title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$x_m$ (m)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,4)(31,4)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,-4)(31,-4)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=xm
        ]{datos/PL6_3.dat};
        %\addlegendentry{$x_m$}
        \addplot[
            color=red,
            mark=none,
            dashed
        ]
        table[
        x=t,
        y=refxm
        ]{datos/PL6_3.dat};
        %\addlegendentry{$ref_{x_m}$}
    \end{axis}
    \end{tikzpicture}
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.8\linewidth,
        scale only axis=false,
        %title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$y_m$ (m)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,2)(31,2)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,0)(31,0)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=ym
        ]{datos/PL6_3.dat};
        %\addlegendentry{$x_m$}
        \addplot[
            color=red,
            mark=none,
            dashed
        ]
        table[
        x=t,
        y=refym
        ]{datos/PL6_3.dat};
        %\addlegendentry{$ref_{x_m}$}
    \end{axis}
    \end{tikzpicture}
    \caption{Comparación referencia vs Salidas del sistema con restricciones terminales}
    %\label{fig:Comparación de velocidad de salida $\omega_e$ con el modelo base}
\end{figure}%xm ym

El análisis de las gráficas obtenidas muestra que, aunque persiste un cierto error en el seguimiento de la referencia de la carga, tanto en $x_m(t)$ como en $y_m(t)$, este resulta claramente menos pronunciado que en el caso anterior sin restricciones terminales. El sistema presenta una evolución más suave y controlada, evidenciando una mejora en la respuesta global.

\begin{figure}[H]
    \centering
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.6\linewidth,
        scale only axis=false,
        title={Estados del sistema},
        xlabel={t(s)},
        ylabel={$x$ (m)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,5)(31,5)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,-5)(31,-5)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=x
        ]{datos/PL6_3.dat};
        %\addlegendentry{$x_m$}
    \end{axis}
    \end{tikzpicture}
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.6\linewidth,
        scale only axis=false,
        %title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$dl$ (m)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,2)(31,2)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,0)(31,0)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=l
        ]{datos/PL6_3.dat};
        %\addlegendentry{$x_m$}
    \end{axis}
    \end{tikzpicture}
    \begin{tikzpicture}
    \begin{axis}[
        width=0.92\linewidth,
        height=0.6\linewidth,
        scale only axis=false,
        %title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$\theta$ (rad)},
         y tick label style={
            /pgf/number format/fixed,
            /pgf/number format/precision=4
        },
        scaled y ticks=false,
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,0.07854)(31,0.07854)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,-0.07854)(31,-0.07854)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=theta
        ]{datos/PL6_3.dat};
        %\addlegendentry{$x_m$}
    \end{axis}
    \end{tikzpicture}
    \caption{Estados del sistema: Variables internas con restricciones terminales}
    %\label{fig:Comparación de velocidad de salida $\omega_e$ con el modelo base}
\end{figure}%x l theta

De forma análoga a la situación descrita en la pregunta anterior, se observa que el único estado que alcanza su límite impuesto es el ángulo $\theta(t)$. No obstante, en este caso dicha saturación ocurre en un menor número de instantes y durante intervalos de tiempo más reducidos, lo que permite al controlador disponer de mayor margen de actuación para compensar la dinámica no lineal del sistema.

Como consecuencia, el seguimiento de la trayectoria de la carga mejora respecto al escenario con restricciones angulares más severas sin condiciones terminales. Este resultado pone de manifiesto que la inclusión de restricciones terminales contribuye a una mayor estabilidad del sistema y a un compromiso más favorable entre el cumplimiento de las restricciones y el desempeño del seguimiento, reduciendo el impacto negativo de la saturación del ángulo $\theta(t)$ sobre la salida.

\subsection{Aumento de la frecuencia de la referencia y resintonización}

\lstinputlisting[language=MATLAB, firstline=256, lastline=262]{codigo/ControladorNMPC_Grua.m}

Al duplicar la frecuencia de los senos y cosenos que definen la referencia, se observa que la simulación falla alrededor del instante $t \approx 9.1$ s. Este comportamiento indica que el controlador NMPC, con la sintonía inicial, no es capaz de gestionar la mayor exigencia dinámica.

Para recuperar la viabilidad del problema de optimización, se resintoniza el controlador modificando los parámetros de ponderación. Se reduce progresivamente el peso de $r_{x_m}$ hasta alcanzar un equilibrio que permita seguir la referencia sin saturaciones en $\theta(t)$. El análisis de $r_\theta$ no muestra cambios significativos, por lo que se mantiene con el valor original.

Tras la resintonización, se consigue estabilizar el sistema, aunque persisten errores apreciables en el seguimiento de la referencia tanto en $x_m(t)$ como en $y_m(t)$. Observando que el eje $y$ aún presenta margen de mejora, se incrementa progresivamente el valor de ponderación $r_{y_m}$ hasta lograr un seguimiento de la referencia satisfactorio en dicha coordenada.

El parámetro $q_{\Delta f_x}$ penaliza los cambios bruscos en la fuerza horizontal, limitando aceleraciones excesivas. Un peso elevado mejora la suavidad de $f_x(t)$ pero reduce la rapidez de respuesta, degradando el seguimiento de la referencia en $x_m(t)$, especialmente cuando $\theta(t)$ está cerca de sus límites. Por el contrario, reducir esta ponderación permite variaciones más agresivas de la fuerza, mejorando el seguimiento pero aumentando las oscilaciones de control y la proximidad a las restricciones angulares.

De forma similar, el parámetro $q_{\Delta f_y}$ controla las variaciones de la fuerza vertical. Ajustes en este parámetro afectan a la dinámica de la coordenada $y_m(t)$ y a la evolución de la longitud del cable $l(t)$.

Tras múltiples ensayos variando ambos parámetros $q_{\Delta f_x}$ y $q_{\Delta f_y}$, se concluye que el desempeño del sistema es insensible a cambios razonables en estas ponderaciones. Por tanto, se mantienen ambos parámetros con sus valores originales, evitando introducir complejidad innecesaria en la sintonía del controlador.

Tras el proceso de ajuste, los valores finales de ponderación utilizados en el controlador han sido: 
% \begin{equation}
% r_{x_m}=33,\quad r_{y_m}=80,\quad r_{\theta}=10,\quad q_{\Delta f_x}=q_{\Delta f_l}=0.01.
% \end{equation}
\lstinputlisting[language=MATLAB, firstline=103, lastline=107]{codigo/ControladorNMPC_Grua.m}

\subsection{Resultados con los parámetros resintonizados}

\begin{figure}[H]
    \centering
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.8\linewidth,
        scale only axis=false,
        title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$x_m$ (m)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,4)(31,4)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,-4)(31,-4)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=xm
        ]{datos/PL6_4.dat};
        %\addlegendentry{$x_m$}
        \addplot[
            color=red,
            mark=none,
            dashed
        ]
        table[
        x=t,
        y=refxm
        ]{datos/PL6_4.dat};
        %\addlegendentry{$ref_{x_m}$}
    \end{axis}
    \end{tikzpicture}
    \begin{tikzpicture}
    \begin{axis}[
        width=0.96\linewidth,
        height=0.8\linewidth,
        scale only axis=false,
        %title={Salidas del sistema},
        xlabel={t(s)},
        ylabel={$y_m$ (m)},
        grid=major,
        %ytick={0, 200, 400, 600, 800, 1000, 1200, 1400},
        xmin=00, % El eje X empieza en 0
        xmax=30,
        legend pos=south east
    ]
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,2)(31,2)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=green,
            mark=none,
            dashed
        ]
        coordinates{
            (0,0)(31,0)
        };
        %\addlegendentry{$ref_{x_m}$}
        \addplot[
            color=NavyBlue,
            mark=none
        ]
        table[
        x=t,
        y=ym
        ]{datos/PL6_4.dat};
        %\addlegendentry{$x_m$}
        \addplot[
            color=red,
            mark=none,
            dashed
        ]
        table[
        x=t,
        y=refym
        ]{datos/PL6_4.dat};
        %\addlegendentry{$ref_{x_m}$}
    \end{axis}
    \end{tikzpicture}
    \caption{Comparación referencia vs Salidas del sistema con parámetros resintonizados}
    \label{fig:P6_resultados_finales}
\end{figure}%xm ym

La Fig.~\ref{fig:P6_resultados_finales} recoge las trayectorias obtenidas con los parámetros finales; se observa que la respuesta se mantiene estable y el sistema cumple las restricciones, si bien el seguimiento de la referencia en el eje $x$ no es satisfactorio. 
Este comportamiento se explica porque la restricción sobre $\theta$ vuelve a activarse de forma recurrente (saturación del ángulo), limitando el balanceo permisible del péndulo y, en consecuencia, las aceleraciones horizontales que el sistema puede generar para seguir una referencia más rápida; por ello, aunque la resintonización evita el fallo de simulación y estabiliza el lazo, el desempeño en $x_m(t)$ queda condicionado por la propia restricción angular. 

% \begin{figure}[H]
%     \centering
%     % Sustituir por los nombres reales de tus capturas:
%     \includegraphics[width=0.95\linewidth]{fotos/P6_parametros_finales.png}\par\vspace{2mm}
%     \includegraphics[width=0.95\linewidth]{fotos/P6_resultados_finales.png}
%     \caption{Parámetros finales de resintonización (arriba) y respuestas del sistema con las nuevas ponderaciones (abajo).}
%     \label{fig:P6_resultados_finales}
% \end{figure}